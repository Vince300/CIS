# Scripts de provisioning

## Général

Le frontend agit en tant que passerelle pour les machines worker.

Toutes les machines sont connectés via un hub à l'interface eth1 du gateway. Le réseau utilisé est
192.168.0.0/24. L'interface eth0 du gateway est configurée automatiquement sur le réseau Ensimag
pour l'accès depuis les autres sites.

Les machines à l'intérieur du réseau ont accès à Internet pour la configuration et les mises à jour,
mais les machines internes ne sont accessibles qu'en passant par le frontend.

## A exécuter sur les workers

* Configurer l'interface réseau, reboot.

```
# /etc/network/interfaces
# For ensipc375, xxx = 75
# If ensipc376 is the gateway, yyy = 76

iface eth0 inet static
    address 192.168.0.xxx
    netmask 255.255.255.0
    gateway 192.168.0.yyy
```

* Transférer le dossier provisioning en tant que l'utilisateur install via SFTP.

* En SSH en tant q'utilisateur install, passer root avec su puis exécuter:

```
./00-machine.sh
./01-docker.sh
./02-motd.sh
./03-passenger.sh
# Suivre les instructions de 04-install-keys-worker.txt
./06-workerd.sh
./80-hostfile-worker.sh
./99-finalize.sh
```

## A exécuter sur le frontend

* Configurer l'interface réseau.

```
# /etc/network/interfaces
# For ensipc375, xxx = 75

iface eth1 inet static
    address 192.168.0.xxx
    netmask 255.255.255.0
```

* Installer iptables-persistent

```
apt-get install -y iptables-persistent
```

* Remplacer les règles IPv4 par celles-ci

```
# Generated by iptables-save v1.4.21 on Thu Nov 17 11:17:58 2016
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i eth1 -p udp -m udp --dport 53 -m state --state NEW,ESTABLISHED -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -d 127.0.0.0/8 ! -i lo -j REJECT --reject-with icmp-port-unreachable
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7
-A INPUT -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -i eth1 -o eth0 -j ACCEPT
-A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -j ACCEPT
COMMIT
# Completed on Thu Nov 17 11:17:58 2016
# Generated by iptables-save v1.4.21 on Thu Nov 17 11:17:58 2016
*nat
:PREROUTING ACCEPT [47892:11760278]
:INPUT ACCEPT [71:4260]
:OUTPUT ACCEPT [745:48925]
:POSTROUTING ACCEPT [41:2460]
-A POSTROUTING -o eth0 -j MASQUERADE
COMMIT
# Completed on Thu Nov 17 11:17:58 2016
```

* Activer l'IP forwarding dans les paramètres système (/etc/sysctl.conf)

```
net.ipv4.ip_forward=1
```

* Transférer le dossier provisioning en tant que l'utilisateur install via SFTP.

* En SSH en tant q'utilisateur install, passer root avec su puis exécuter:

```
./00-machine.sh
./02-motd.sh
./03-passenger.sh
cat 04-install-keys.txt
# Suivre les instructions de 04-install-keys-frontend.txt
./07-frontend.sh
./08-quota.sh
# reboot
./09-finalize-quota.sh
./81-hostfile-frontend.sh
./99-finalize.sh
```
