# Scripts de provisioning

## A exécuter sur les workers

* Configurer l'interface réseau, reboot.

```
# /etc/network/interfaces
# For ensipc375, xxx = 75
# If ensipc376 is the gateway, yyy = 76

iface eth0 inet static
    address 192.168.0.xxx
    netmask 255.255.255.0
    gateway 192.168.0.yyy
```

* Transférer: *.sh, deploy/ensipcxxx.crt -> machine.crt, deploy/ensipcxxx.key -> machine.key
en tant que l'utilisateur install via SFTP.

* En SSH en tant q'utilisateur install, passer root avec su puis exécuter:

```
./00-machine.sh
./01-docker.sh
./02-motd.sh
./03-passenger.sh
mv machine.{crt,key} /srv/
chown grid:grid /srv/*
chmod 0400 /srv/*
./06-workerd.sh
./99-finalize.sh
```

## A exécuter sur le frontend

* Configurer l'interface réseau.

```
# /etc/network/interfaces
# For ensipc375, xxx = 75

iface eth1 inet static
    address 192.168.0.xxx
    netmask 255.255.255.0
```

* Installer iptables-persistent

```
apt-get install -y iptables-persistent
```

* Remplacer les règles IPv4 par celles-ci

```
# Generated by iptables-save v1.4.21 on Wed Nov 16 15:26:33 2016
*nat
-A POSTROUTING -o eth0 -j MASQUERADE
COMMIT
# Completed on Wed Nov 16 15:26:33 2016
# Generated by iptables-save v1.4.21 on Wed Nov 16 15:26:33 2016
*filter
# Loopback rules
-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT
# Accept established input
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# Allow output traffic
-A OUTPUT -j ACCEPT
# Allow HTTP and HTTPS from everywhere
-A INPUT -p tcp --dport 80 -j ACCEPT
-A INPUT -p tcp --dport 443 -j ACCEPT
# Allow SSH
-A INPUT -p tcp -m state --state NEW --dport 22 -j ACCEPT
# Allow ping
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
# Log denied calls
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7
# Reject all other inbound
-A INPUT -j REJECT
# Forward traffic for internal network
-A FORWARD -i eth1 -o eth0 -j ACCEPT
-A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Wed Nov 16 15:26:33 2016
```

* Activer l'IP forwarding dans les paramètres système (/etc/sysctl.conf)

```
net.ipv4.ip_forward=1
```

* Transférer: *.sh, deploy/ensipcxxx.crt -> machine.crt, deploy/ensipcxxx.key -> machine.key
en tant que l'utilisateur install via SFTP.

* En SSH en tant q'utilisateur install, passer root avec su puis exécuter:

```
./00-machine.sh
./02-motd.sh
./03-passenger.sh
mv machine.{crt,key} /srv/
chown grid:grid /srv/*
chmod 0400 /srv/*
./07-frontend.sh
./99-finalize.sh
```

